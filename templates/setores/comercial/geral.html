{% extends "setores/comercial.html" %}

{% block comercial_content %}
    <div class="filter-container">
        <form action="" method="GET" class="date-filter-form">
            <div class="form-group">
                <label for="start_date">Data Inicial:</label>
                <input type="date" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="form-group">
                <label for="end_date">Data Final:</label>
                <input type="date" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>
            <button type="submit" class="btn-filter">Filtrar</button>
        </form>
    </div>


    {% if kpis %}
    <div class="kpi-grid">
        {% set nf_saida = kpis.get('NOTA FISCAL DE SAÍDA') %}
        {% if nf_saida %}
        <div class="kpi-card nf-saida">
            <h3>{{ nf_saida.TipoNs }}</h3>
            <div class="kpi-main-value">{{ nf_saida.Valor_fmt }}</div>
            <div class="kpi-secondary-values">
                <span><strong>Peso:</strong> {{ nf_saida.Peso_fmt }}</span>
                <span><strong>Quantidade:</strong> {{ nf_saida.Quantidade_fmt }}</span>
            </div>
        </div>
        {% endif %}

        {% set cancelamentos = kpis.get('CANCELAMENTO') %}
        {% if cancelamentos %}
        <div class="kpi-card cancelamentos">
            <h3>{{ cancelamentos.TipoNs }}</h3>
            <div class="kpi-main-value">{{ cancelamentos.Valor_fmt }}</div>
            <div class="kpi-secondary-values">
                <span><strong>Peso:</strong> {{ cancelamentos.Peso_fmt }}</span>
                <span><strong>Quantidade:</strong> {{ cancelamentos.Quantidade_fmt }}</span>
            </div>
        </div>
        {% endif %}

        {% set devolucoes = kpis.get('DEVOLUÇÃO') %}
        {% if devolucoes %}
        <div class="kpi-card devolucoes">
            <h3>{{ devolucoes.TipoNs }}</h3>
            <div class="kpi-main-value">{{ devolucoes.Valor_fmt }}</div>
            <div class="kpi-secondary-values">
                <span><strong>Peso:</strong> {{ devolucoes.Peso_fmt }}</span>
                <span><strong>Quantidade:</strong> {{ devolucoes.Quantidade_fmt }}</span>
            </div>
        </div>
        {% endif %}
        
        {% set faturamento = kpis.get('FATURAMENTO LÍQUIDO') %}
        {% if faturamento %}
        <div class="kpi-card faturamento-liquido">
            <h3>{{ faturamento.TipoNs }}</h3>
            <div class="kpi-main-value">{{ faturamento.Valor_fmt }}</div>
            <div class="kpi-secondary-values">
                <span><strong>Peso:</strong> {{ faturamento.Peso_fmt }}</span>
                <span><strong>Quantidade:</strong> {{ faturamento.Quantidade_fmt }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    {% if chart_data and chart_data.labels %}
    <div class="box-container" style="margin-top: 2rem; padding: 1.5rem;">
        <h3 style="margin-top:0; text-align: center; color: var(--text-secondary);">Faturamento Diário x Peso</h3>
        <div style="position: relative; height: 50vh; width: 100%;">
            <canvas id="faturamentoChart"></canvas>
        </div>
    </div>
    {% endif %}


    {% if chart_data and chart_data.preco_kg_data and chart_data.desconto_data %}
    <div class="charts-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
        <div class="box-container" style="padding: 1.5rem;">
            <h3 style="margin-top:0; text-align: center; color: var(--text-secondary);">Preço Médio por KG (R$)</h3>
            <div style="position: relative; height: 35vh; width: 100%;">
                <canvas id="precoKgChart"></canvas>
            </div>
        </div>
        <div class="box-container" style="padding: 1.5rem;">
            <h3 style="margin-top:0; text-align: center; color: var(--text-secondary);">Desconto Médio (%)</h3>
            <div style="position: relative; height: 35vh; width: 100%;">
                <canvas id="descontoChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
        <div class="alert alert-info">Nenhum dado para exibir no período selecionado.</div>
    {% endif %}
{% endblock %}

{% block scripts %}
{% if chart_data and chart_data.labels %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    Chart.register(ChartDataLabels);
    
    
    const formatCurrency = (value) => 
        new Intl.NumberFormat('pt-BR', { 
            style: 'currency', 
            currency: 'BRL',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);

    const formatCurrencyWithCents = (value) =>
        new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2
        }).format(value);

    const formatPricePerKg = (value) => `${value.toFixed(2).replace('.', ',')} R$/kg`;

    const formatWeight = (value) => (value / 1000).toFixed(1).replace('.', ',') + 't';
    
    const formatPercent = (value) => `${value.toFixed(1).replace('.', ',')}%`;


    const chartData = {{ chart_data|tojson }};
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
    const backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-bg').trim();
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--grid-color', 'rgba(0, 0, 0, 0.1)').trim();
    
    const primaryColor = '#023047';
    const secondaryColor = '#ebd774';

    const ctx = document.getElementById('faturamentoChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Faturamento (R$)',
                    data: chartData.faturamento_data,
                    type: 'line',
                    borderColor: primaryColor,
                    backgroundColor: 'transparent',
                    yAxisID: 'yFaturamento',
                    tension: 0.4,
                    order: 0
                },
                {
                    label: 'Peso (kg)',
                    data: chartData.peso_data,
                    backgroundColor: secondaryColor,
                    yAxisID: 'yPeso',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.dataset.yAxisID === 'yFaturamento') {
                                label += formatCurrency(context.raw);
                            } else {
                                label += new Intl.NumberFormat('pt-BR').format(context.raw) + ' kg';
                            }
                            return label;
                        }
                    }
                },
                datalabels: {
                    display: (context) => context.dataset.type === 'line',
                    color: textColor,
                    anchor: 'end',
                    align: 'end',
                    offset: -8,
                    font: { weight: 'bold', size: 10 },
                    formatter: (value) => formatCurrency(value),
                    textStrokeColor: backgroundColor,
                    textStrokeWidth: 4,
                    padding: 0
                },
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { color: textColor }
                },
                yFaturamento: {
                    display: false
                },
                yPeso: {
                    display: false
                }
            },
            animation: {
                onComplete: ({ chart }) => {
                    const ctx = chart.ctx;
                    chart.data.datasets.forEach((dataset, i) => {
                        if (dataset.type !== 'line') {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const data = formatWeight(dataset.data[index]);
                                ctx.save();
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';
                                ctx.font = 'bold 10px Segoe UI';
                                const yPos = bar.y - 5;
                                
                                ctx.lineWidth = 4;
                                ctx.strokeStyle = backgroundColor;
                                ctx.strokeText(data, bar.x, yPos);
                                
                                ctx.fillStyle = textColor;
                                ctx.fillText(data, bar.x, yPos);
                                
                                ctx.restore();
                            });
                        }
                    });
                }
            }
        }
    });

 if (document.getElementById('precoKgChart') && chartData.preco_kg_data) {
        const ctxPreco = document.getElementById('precoKgChart').getContext('2d');
        new Chart(ctxPreco, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Preço/kg (R$)',
                    data: chartData.preco_kg_data,
                    borderColor: '#ee9b00',
                    backgroundColor: 'rgba(238, 155, 0, 0.1)',
                    fill: true,
                    tension: 0.4,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (c) => `Preço/kg: ${formatCurrencyWithCents(c.raw)}` } },
                    datalabels: {
                        color: textColor, anchor: 'end', align: 'end',
                        font: { weight: 'bold', size: 9 },
                        formatter: (v) => formatPricePerKg(v),
                        textStrokeColor: backgroundColor, textStrokeWidth: 4, padding: 0,
                    }
                },
                scales: {
                    x: { display: true, grid: { display: false }, ticks: { color: textColor } },
                    y: { display: false}
                   }
            }
        });
    }
 if (document.getElementById('descontoChart') && chartData.desconto_data) {
        const ctxDesconto = document.getElementById('descontoChart').getContext('2d');
        new Chart(ctxDesconto, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Desconto Médio (%)',
                    data: chartData.desconto_data,
                    borderColor: '#2a9d8f',
                    backgroundColor: 'rgba(42, 157, 143, 0.1)',
                    fill: true,
                    tension: 0.4,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (c) => `Desconto: ${formatPercent(c.raw)}` } },
                    datalabels: {
                        color: textColor, anchor: 'end', align: 'end',
                        font: { weight: 'bold', size: 9 },
                        formatter: (v) => formatPercent(v),
                        textStrokeColor: backgroundColor, textStrokeWidth: 4, padding: 0,
                    }
                },
                scales: {
                    x: { display: true, grid: { display: false }, ticks: { color: textColor } },
                    y: { display: false}
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}