{% extends "layout.html" %}

{% block title %}Detalhes do Chamado{% endblock %}

{% macro render_attachments(attachments) %}
    {% if attachments %}
        <div class="carousel-container" style="margin-top: 1rem;">
            <div class="carousel-slides">
                {% for attachment in attachments %}
                    <div class="carousel-slide">
                        {% if attachment.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                            <a href="{{ url_for('tickets.download_file', attachment_id=attachment.id) }}" target="_blank">
                                <img src="{{ url_for('tickets.download_file', attachment_id=attachment.id) }}" alt="{{ attachment.filename }}">
                            </a>
                        {% else %}
                            <a href="{{ url_for('tickets.download_file', attachment_id=attachment.id) }}" target="_blank">{{ attachment.filename }}</a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            {% if attachments|length > 1 %}
                <button class="carousel-button prev" onclick="moveSlide(this, -1)">&#10094;</button>
                <button class="carousel-button next" onclick="moveSlide(this, 1)">&#10095;</button>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{% block content %}

{% include 'tickets/components/_ticket_details.html' %}

{% if is_admin %}
    {% include 'tickets/components/_admin_actions.html' %}
{% endif %}

{% if ticket.ticket_type == 'projeto' %}
<div class="box-container project-stages-container">
    <h3>Etapas do Projeto</h3>
    {% for stage in ticket.project_stages %}
    <div class="project-stage">
        <div class="project-stage-header">
            <span class="project-stage-name">{{ stage.name }}</span>
            <div class="stage-actions">
                {% if is_admin %}
                <form method="post" style="display: inline-block;">
                    <input type="hidden" name="form_action" value="update_stage_status">
                    <input type="hidden" name="stage_id" value="{{ stage.id }}">
                    <select name="new_status" class="interaction-status-select" onchange="this.form.submit()">
                        <option value="Pendente" {% if stage.status == 'Pendente' %}selected{% endif %}>Pendente</option>
                        <option value="Em Andamento" {% if stage.status == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
                        <option value="Concluído" {% if stage.status == 'Concluído' %}selected{% endif %}>Concluído</option>
                    </select>
                </form>
                {% endif %}
                <span class="stage-status stage-status-{{ stage.status|lower|replace(' ', '-') }}">{{ stage.status }}</span>
            </div>
        </div>
        <div class="project-stage-details">
            Prazo: {{ stage.deadline.strftime('%d/%m/%Y %H:%M') if stage.deadline else 'Não definido' }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="box-container" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Histórico de Interações</h3>
        {% if ticket.ticket_type == 'projeto' %}
        <form method="get" id="stage_filter_form">
            <select name="stage_filter" id="stage_filter" class="interaction-status-select" onchange="this.form.submit()">
                <option value="">Todas as Etapas</option>
                <option value="geral" {% if stage_filter == 'geral' %}selected{% endif %}>Geral</option>
                {% for stage in ticket.project_stages %}
                    <option value="{{ stage.id }}" {% if stage_filter == stage.id|string %}selected{% endif %}>{{ stage.name }}</option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
    </div>
    
    {% macro render_interaction(interaction, ticket_user_email, current_user_is_admin) %}
        {% set is_validation_request = interaction.action_type == 'request_validation' %}
        {% set validation_status = interaction.interaction_data.validation_status if is_validation_request else None %}

        <div class="reply 
            {% if interaction.user_email == ticket_user_email %}user-reply{% else %}admin-reply{% endif %}
            {% if is_validation_request %}validation-request{% endif %}">
            
            <p>
                <strong>{{ interaction.user_email }}</strong> em {{ interaction.timestamp.strftime('%d/%m/%Y %H:%M') }}
                {% if interaction.stage %} em <strong>{{ interaction.stage.name }}</strong>{% endif %}
                {% if is_validation_request %}
                    - <span class="status-badge validation-{{ validation_status }}-badge">{{ validation_status|capitalize }}</span>
                    {% if current_user_is_admin %}
                        <form method="post" style="display: inline-block; margin-left: 1rem;">
                            <input type="hidden" name="form_action" value="update_interaction_status">
                            <input type="hidden" name="interaction_id" value="{{ interaction.id }}">
                            <select name="new_status" onchange="this.form.submit()" class="interaction-status-select">
                                <option value="pending" {% if validation_status == 'pending' %}selected{% endif %}>Pendente</option>
                                <option value="completed" {% if validation_status == 'completed' %}selected{% endif %}>Concluído</option>
                                <option value="canceled" {% if validation_status == 'canceled' %}selected{% endif %}>Cancelado</option>
                            </select>
                        </form>
                    {% endif %}
                {% endif %}
            </p>

            <div style="word-wrap: break-word;">
                {% if interaction.action_type in ['comment', 'request_validation'] %}
                    {% if interaction.action_type == 'request_validation' %}<strong>Pedido de Validação:</strong>{% endif %}
                    {{ interaction.text|nl2br }}
                {% elif interaction.action_type == 'status_change' %}
                    <p>Status <strong>{{ interaction.interaction_data.old_status }}</strong> ▶ <strong>{{ interaction.interaction_data.new_status }}</strong>.</p>
                {% elif interaction.action_type == 'assign' %}
                    <p>Chamado atribuído a <strong>{{ interaction.interaction_data.new_assignee or 'Ninguém' }}</strong></p>
                {% endif %}
            </div>

            {{ render_attachments(interaction.attachments) }}

            {% if interaction.interaction_data.external_ticket_id %}
                <div class="external-ticket-link">
                    {% if interaction.interaction_data.external_system %}
                        Vinculado a: <strong>{{ interaction.interaction_data.external_system }} #</strong>
                    {% else %}
                        Link Externo: 
                    {% endif %}
                    {{ interaction.interaction_data.external_ticket_id | autolink | safe }}
                </div>
            {% endif %}
            
            {% if interaction.deadline %}<p><small><strong>Prazo para esta ação:</strong> {{ interaction.deadline.strftime('%d/%m/%Y %H:%M') }}</small></p>{% endif %}
            
            {% if is_validation_request and validation_status == 'pending' and not current_user_is_admin %}
            <form method="post" style="margin-top: 1rem;">
                <input type="hidden" name="form_action" value="provide_validation">
                <input type="hidden" name="parent_interaction_id" value="{{ interaction.id }}">
                <button type="submit" name="validation_response" value="approved" class="btn">Aprovar</button>
                <button type="submit" name="validation_response" value="rejected" class="btn btn-secondary">Rejeitar</button>
            </form>
            {% endif %}

            {% for child in interaction.children %}
                <div class="reply validation-response 
                    {% if child.interaction_data.validation_status == 'approved' %}validation-approved
                    {% elif child.interaction_data.validation_status == 'rejected' %}validation-rejected
                    {% endif %}">
                    <p><strong>{{ child.user_email }}</strong> respondeu em {{ child.timestamp.strftime('%d/%m/%Y %H:%M') }}:
                        {% if child.action_type == 'provide_validation' %}
                            Validação: <strong>{{ child.interaction_data.validation_status|capitalize }}</strong>
                        {% elif child.action_type == 'status_change_manual' %}
                            Status da ação alterado de <strong>{{ child.interaction_data.old_status }}</strong> para <strong>{{ child.interaction_data.new_status }}</strong>.
                        {% endif %}
                    </p>
                </div>
            {% endfor %}
        </div>
    {% endmacro %}

    {# Loop Principal #}
    {% if interactions|length > 0 %}
        {% for interaction in interactions %}
            {{ render_interaction(interaction, ticket.user_email, is_admin) }}
        {% endfor %}
    {% else %}
        <p>Nenhuma interação encontrada com o filtro aplicado.</p>
    {% endif %}

    {% include 'tickets/components/_interaction_form.html' %}
</div>

<a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-secondary" style="margin-top: 2rem;">Voltar para a Lista</a>
{% endblock %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.carousel-container').forEach(function(container) {
            const slidesContainer = container.querySelector('.carousel-slides');
            if (!slidesContainer) return;
            container.dataset.slideIndex = 0;
        });
    });

    function moveSlide(buttonElem, n) {
        const container = buttonElem.closest('.carousel-container');
        const slidesContainer = container.querySelector('.carousel-slides');
        const slides = container.querySelectorAll('.carousel-slide');
        if (!container || !slidesContainer || slides.length <= 1) return;

        let index = parseInt(container.dataset.slideIndex || 0, 10);
        index += n;

        if (index >= slides.length) index = 0;
        if (index < 0) index = slides.length - 1;

        container.dataset.slideIndex = index;
        slidesContainer.style.transform = `translateX(-${index * 100}%)`;
    }
</script>
{% endblock %}