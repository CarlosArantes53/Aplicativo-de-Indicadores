{% extends "layout.html" %}

{% block title %}Meus Chamados{% endblock %}

{% block content %}
    <a href="{{ url_for('tickets.create_ticket') }}" class="btn">Abrir Novo Chamado</a>

    {# --- Formul√°rio de Filtros --- #}
    <div class="filter-box" style="margin-top: 2rem;">
        <form method="get" action="{{ url_for('tickets.list_tickets') }}" class="filter-form">
            {# --- Macro para gerar links de ordena√ß√£o (CORRIGIDA) --- #}
            {% macro sort_link(field, display_text) %}
                {% set order_val = 'asc' if current_sorting.by == field and current_sorting.order == 'desc' else 'desc' %}
                {% set url = url_for_with_query('tickets.list_tickets', sort_by=field, order=order_val) %}
                <a href="{{ url }}" class="sort-link {% if current_sorting.by == field %}active{% endif %}">
                    <span>{{ display_text }}</span>
                    {% if current_sorting.by == field %}
                        <span class="sort-indicator">{{ '‚ñ≤' if current_sorting.order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </a>
            {% endmacro %}


            <div class="input-group">
                <label for="title">{{ sort_link('title', 'Buscar T√≠tulo') }}</label>
                <input type="text" name="title" id="title" value="{{ current_filters.get('title', '') }}">
            </div>
            
            <div class="input-group">
                <label for="status">{{ sort_link('status', 'Status') }}</label>
                <div class="checkbox-group">
                    {% for status in filter_options.statuses %}
                    <label>
                        <input type="checkbox" name="status" value="{{ status }}" {% if status in current_filters.get('status', []) %}checked{% endif %}>
                        {{ status }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="input-group">
                <label for="urgency">{{ sort_link('urgency', 'Urg√™ncia') }}</label>
                <div class="checkbox-group">
                    {% for urgency in filter_options.urgencies %}
                    <label>
                        <input type="checkbox" name="urgency" value="{{ urgency }}" {% if urgency in current_filters.get('urgency', []) %}checked{% endif %}>
                        {{ urgency }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="input-group">
                <label for="sector">{{ sort_link('sector', 'Setor') }}</label>
                <div class="checkbox-group">
                     {% for sector in filter_options.sectors %}
                    <label>
                        <input type="checkbox" name="sector" value="{{ sector }}" {% if sector in current_filters.get('sector', []) %}checked{% endif %}>
                        {{ sector }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="btn">Filtrar</button>
        </form>
    </div>
    
    {% if tickets %}
        <div class="ticket-list-container">
            {% for ticket in tickets %}
            <div class="ticket-item" data-href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}">
                <div class="ticket-main-line">
                    <h4 class="ticket-title" title="{{ ticket.title }}">
                        {% if ticket.ticket_type == 'projeto' %}
                            üöÄ
                        {% else %}
                            üìÅ
                        {% endif %}
                        #{{ ticket.id }} - {{ ticket.title }}
                    </h4>
                    {% if ticket.ticket_type == 'projeto' %}
                        <span class="progress-text">
                            {{ ticket.completed_stages_count }} de {{ ticket.total_stages_count }} &bull; {{ "%.0f"|format(ticket.progress|float) }}%
                        </span>
                        <div class="progress-bar-container">
                            <div class="progress-bar 
                                {% if ticket.progress < 50 %}progress-bar-low
                                {% elif ticket.progress < 100 %}progress-bar-medium
                                {% else %}progress-bar-high{% endif %}" 
                                style="width: {{ ticket.progress }}%;">
                            </div>
                        </div>
                    {% endif %}
                    <span class="urgency-badge urgency-{{ ticket.urgency.lower().replace('√©', 'e').replace('√≠', 'i') }}">{{ ticket.urgency }}</span>
                </div>
                <div class="ticket-meta-line">
                    <span>Criado por: <strong>{{ ticket.user_email }}</strong></span>
                    <span>&bull;</span>
                    <span>Status: <strong>{{ ticket.status }}</strong></span>
                    <span>&bull;</span>
                    <span>Atribu√≠do a: <strong>{{ ticket.assigned_user_email or '-' }}</strong></span>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info" style="margin-top: 2rem;">Nenhum chamado encontrado com os filtros aplicados.</div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const rows = document.querySelectorAll('.ticket-item[data-href]');
    rows.forEach(row => {
        row.addEventListener('click', () => {
            window.location.href = row.dataset.href;
        });
    });
});
</script>
{% endblock %}