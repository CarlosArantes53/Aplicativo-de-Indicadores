{% extends "layout.html" %}

{% block title %}Meus Chamados{% endblock %}

{% block content %}
    <a href="{{ url_for('tickets.create_ticket') }}" class="btn">Abrir Novo Chamado</a>

    {# --- Formul√°rio de Filtros --- #}
    <div class="filter-box" style="margin-top: 2rem;">
        <form method="get" action="{{ url_for('tickets.list_tickets') }}" class="filter-form">
            <div class="input-group">
                <label for="title">Buscar T√≠tulo</label>
                <input type="text" name="title" id="title" value="{{ current_filters.get('title', '') }}">
            </div>
            <div class="input-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="">Todos</option>
                    {% for status in filter_options.statuses %}
                    <option value="{{ status }}" {% if current_filters.get('status') == status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <label for="urgency">Urg√™ncia</label>
                <select name="urgency" id="urgency">
                    <option value="">Todas</option>
                    {% for urgency in filter_options.urgencies %}
                    <option value="{{ urgency }}" {% if current_filters.get('urgency') == urgency %}selected{% endif %}>{{ urgency }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <label for="sector">Setor</label>
                <select name="sector" id="sector">
                    <option value="">Todos</option>
                     {% for sector in filter_options.sectors %}
                    <option value="{{ sector }}" {% if current_filters.get('sector') == sector %}selected{% endif %}>{{ sector }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn">Filtrar</button>
        </form>
    </div>
    
    {% if tickets %}
        <div class="ticket-list-container">
            {% for ticket in tickets %}
            <div class="ticket-item" data-href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}">
                <div class="ticket-main-line">
                    <h4 class="ticket-title" title="{{ ticket.title }}">
                        {% if ticket.ticket_type == 'projeto' %}
                            üöÄ
                        {% else %}
                            üìÅ
                        {% endif %}
                        #{{ ticket.id }} - {{ ticket.title }}
                    </h4>
                    {% if ticket.ticket_type == 'projeto' %}
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ ticket.progress }}%;"></div>
                    </div>
                    {% endif %}
                    <span class="urgency-badge urgency-{{ ticket.urgency.lower().replace('√©', 'e').replace('√≠', 'i') }}">{{ ticket.urgency }}</span>
                </div>
                <div class="ticket-meta-line">
                    <span>Criado por: <strong>{{ ticket.user_email }}</strong></span>
                    <span>&bull;</span>
                    <span>Status: <strong>{{ ticket.status }}</strong></span>
                    <span>&bull;</span>
                    <span>Atribu√≠do a: <strong>{{ ticket.assigned_user_email or '-' }}</strong></span>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info" style="margin-top: 2rem;">Nenhum chamado encontrado com os filtros aplicados.</div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const rows = document.querySelectorAll('.ticket-item[data-href]');
    rows.forEach(row => {
        row.addEventListener('click', () => {
            window.location.href = row.dataset.href;
        });
    });
});
</script>
{% endblock %}