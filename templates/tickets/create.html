{% extends 'layout.html' %}

{% block title %}Abrir Novo Chamado{% endblock %}

{% block content %}
<h1>Abrir Novo Chamado</h1>
<form method="post" enctype="multipart/form-data" class="user-form">
    <div class="input-group">
        <label for="ticket_type">Tipo:</label>
        <select id="ticket_type" name="ticket_type" required>
            <option value="chamado">Chamado</option>
            <option value="projeto">Projeto</option>
        </select>
    </div>

    <div class="input-group">
        <label for="title">Título:</label>
        <input type="text" id="title" name="title" required>
    </div>

    <div class="input-group">
        <label for="urgency">Nível de Urgência:</label>
        <select id="urgency" name="urgency" required>
            <option value="Baixa">Baixa</option>
            <option value="Média">Média</option>
            <option value="Alta">Alta</option>
            <option value="Crítica">Crítica</option>
        </select>
    </div>

    <div class="input-group">
        <label for="sector">Setor:</label>
        <select id="sector" name="sector" required>
            <option value="TI">TI</option>
            <option value="Financeiro">Financeiro</option>
            <option value="Comercial">Comercial</option>
            <option value="RH">RH</option>
            <option value="Operacional">Operacional</option>
        </select>
    </div>

    <div class="input-group">
        <label for="description">Descrição:</label>
        <textarea id="description" name="description" rows="5" required></textarea>
    </div>

    <div class="input-group">
        <label for="deadline">Prazo Final (Opcional):</label>
        <input type="datetime-local" id="deadline" name="deadline" min="{{ now.strftime('%Y-%m-%dT%H:%M') }}">
    </div>
    
    <div id="project_stages_container" style="display: none;">
        <h3>Etapas do Projeto</h3>
        <div id="stages_list">
            </div>
        <button type="button" id="add_stage" class="btn btn-secondary">Adicionar Etapa</button>
    </div>


    <div class="input-group">
        <label for="attachments">Anexos (Opcional):</label>
        <input type="file" id="attachments" name="attachments" multiple>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn">Abrir Chamado</button>
        <a href="{{ url_for('tickets.list_tickets') }}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ticketTypeSelect = document.getElementById('ticket_type');
        const projectStagesContainer = document.getElementById('project_stages_container');
        const addStageButton = document.getElementById('add_stage');
        const stagesList = document.getElementById('stages_list');

        ticketTypeSelect.addEventListener('change', function() {
            if (this.value === 'projeto') {
                projectStagesContainer.style.display = 'block';
            } else {
                projectStagesContainer.style.display = 'none';
            }
        });

        addStageButton.addEventListener('click', function() {
            const stageCount = stagesList.children.length;
            const newStage = document.createElement('div');
            newStage.classList.add('input-group');
            newStage.innerHTML = `
                <label for="stage_name_${stageCount}">Nome da Etapa:</label>
                <input type="text" id="stage_name_${stageCount}" name="stage_name[]" required>
                <label for="stage_deadline_${stageCount}">Prazo da Etapa (Opcional):</label>
                <input type="datetime-local" id="stage_deadline_${stageCount}" name="stage_deadline[]">
            `;
            stagesList.appendChild(newStage);
        });
    });
</script>
{% endblock %}